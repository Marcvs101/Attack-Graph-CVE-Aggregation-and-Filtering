import json, sys, os, logging, traceback
sys.path.append(os.path.join(os.path.dirname(os.path.realpath(__file__)), os.pardir))
import config



class RealInventoryGenerator:

    INVENTORIES_ROOT_FOLDER = config.NETWORK_FOLDER
    INVENTORY_GENENERATOR_RESOURCE_FOLDER = config.ADVISORY_RESOURCES
    PATH_TO_NVD_DUMP = config.nvd_complete_dump

    def load():
        logging.basicConfig(filename='logging/dataset_generator.log', level=logging.DEBUG, 
            format='%(asctime)s - %(levelname)s: %(message)s')
        
        logging.info("[GENERATION] Loading inventory resources...")

        # Load run data
        host_to_scanner_to_step_to_state = dict()
        f = open(RealInventoryGenerator.INVENTORY_GENENERATOR_RESOURCE_FOLDER+"/dockerized_environment/merged/final_state.json",mode="r",encoding="utf-8")
        host_to_scanner_to_step_to_state["merged"] = json.loads(f.read())
        f.close()

        f = open(RealInventoryGenerator.INVENTORY_GENENERATOR_RESOURCE_FOLDER+"/dockerized_environment/nessus/final_state.json",mode="r",encoding="utf-8")
        host_to_scanner_to_step_to_state["nessus"] = json.loads(f.read())
        f.close()

        f = open(RealInventoryGenerator.INVENTORY_GENENERATOR_RESOURCE_FOLDER+"/dockerized_environment/openvas/final_state.json",mode="r",encoding="utf-8")
        host_to_scanner_to_step_to_state["openvas"] = json.loads(f.read())
        f.close()

        # Path is in a file
        f = open(RealInventoryGenerator.PATH_TO_NVD_DUMP,mode="r",encoding="utf-8")
        nvd_dump_path = f.read().strip()
        f.close()

        f = open(nvd_dump_path,mode="r",encoding="utf-8")
        nvd_resource = json.loads(f.read())
        f.close()

        # Compile resources
        host_to_scanner_to_step_to_vulnerabilities = dict()
        for host in host_to_scanner_to_step_to_state["merged"]:
            if host not in host_to_scanner_to_step_to_vulnerabilities:
                host_to_scanner_to_step_to_vulnerabilities[host] = dict()
                host_to_scanner_to_step_to_vulnerabilities[host]["merged"] = dict()
                host_to_scanner_to_step_to_vulnerabilities[host]["nessus"] = dict()
                host_to_scanner_to_step_to_vulnerabilities[host]["openvas"] = dict()
            
            for step in range(1,2,3):
                host_to_scanner_to_step_to_vulnerabilities[host]["merged"][step] = dict()
                host_to_scanner_to_step_to_vulnerabilities[host]["merged"][step]["open"] = list()
                host_to_scanner_to_step_to_vulnerabilities[host]["merged"][step]["confirmed"] = list()
                host_to_scanner_to_step_to_vulnerabilities[host]["merged"][step]["discarded"] = list()

                host_to_scanner_to_step_to_vulnerabilities[host]["merged"][step]["open"] = host_to_scanner_to_step_to_state["merged"][host]["open_cve"]
                host_to_scanner_to_step_to_vulnerabilities[host]["merged"][step]["confirmed"] = host_to_scanner_to_step_to_state["merged"][host]["confirmed_cve"]
                host_to_scanner_to_step_to_vulnerabilities[host]["merged"][step]["discarded"] = host_to_scanner_to_step_to_state["merged"][host]["discarded_cve"]


        for host in host_to_scanner_to_step_to_state["nessus"]:
            host_to_scanner_to_step_to_vulnerabilities[host]["nessus"]["open"] = host_to_scanner_to_step_to_state["nessus"][host]["open_cve"]
            host_to_scanner_to_step_to_vulnerabilities[host]["nessus"]["confirmed"] = host_to_scanner_to_step_to_state["nessus"][host]["confirmed_cve"]
            host_to_scanner_to_step_to_vulnerabilities[host]["nessus"]["discarded"] = host_to_scanner_to_step_to_state["nessus"][host]["discarded_cve"]
            
            for step in range(1,2,3):
                host_to_scanner_to_step_to_vulnerabilities[host]["nessus"][step] = dict()
                host_to_scanner_to_step_to_vulnerabilities[host]["nessus"][step]["open"] = list()
                host_to_scanner_to_step_to_vulnerabilities[host]["nessus"][step]["confirmed"] = list()
                host_to_scanner_to_step_to_vulnerabilities[host]["nessus"][step]["discarded"] = list()

                host_to_scanner_to_step_to_vulnerabilities[host]["nessus"][step]["open"] = host_to_scanner_to_step_to_state["nessus"][host]["open_cve"]
                host_to_scanner_to_step_to_vulnerabilities[host]["nessus"][step]["confirmed"] = host_to_scanner_to_step_to_state["nessus"][host]["confirmed_cve"]
                host_to_scanner_to_step_to_vulnerabilities[host]["nessus"][step]["discarded"] = host_to_scanner_to_step_to_state["nessus"][host]["discarded_cve"]

        
        for host in host_to_scanner_to_step_to_state["openvas"]:
            host_to_scanner_to_step_to_vulnerabilities[host]["openvas"]["open"] = host_to_scanner_to_step_to_state["openvas"][host]["open_cve"]
            host_to_scanner_to_step_to_vulnerabilities[host]["openvas"]["confirmed"] = host_to_scanner_to_step_to_state["openvas"][host]["confirmed_cve"]
            host_to_scanner_to_step_to_vulnerabilities[host]["openvas"]["discarded"] = host_to_scanner_to_step_to_state["openvas"][host]["discarded_cve"]

            for step in range(1,2,3):
                host_to_scanner_to_step_to_vulnerabilities[host]["openvas"][step] = dict()
                host_to_scanner_to_step_to_vulnerabilities[host]["openvas"][step]["open"] = list()
                host_to_scanner_to_step_to_vulnerabilities[host]["openvas"][step]["confirmed"] = list()
                host_to_scanner_to_step_to_vulnerabilities[host]["openvas"][step]["discarded"] = list()

                host_to_scanner_to_step_to_vulnerabilities[host]["openvas"][step]["open"] = host_to_scanner_to_step_to_state["openvas"][host]["open_cve"]
                host_to_scanner_to_step_to_vulnerabilities[host]["openvas"][step]["confirmed"] = host_to_scanner_to_step_to_state["openvas"][host]["confirmed_cve"]
                host_to_scanner_to_step_to_vulnerabilities[host]["openvas"][step]["discarded"] = host_to_scanner_to_step_to_state["openvas"][host]["discarded_cve"]


        logging.info("[GENERATION] Inventory resources compiled, initiating generation.")

        return host_to_scanner_to_step_to_vulnerabilities, nvd_resource


    def run(params):
        
        logging.basicConfig(filename='logging/dataset_generator.log', level=logging.DEBUG, 
            format='%(asctime)s - %(levelname)s: %(message)s')
        
        strategy,step,nvd_resource = params

        # Generate hosts

        logging.info("[GENERATION] Real scenario, Hosts with strategy:%d-step:%d", strategy,step)
        host_list = list()

        try:
            for host_index in range(num_hosts):
                host_struct = dict()
                host_struct["id"] = "host-"+str(host_index)
                host_struct["hostname"] = "generated_host"
                host_struct["type"] = "synthetic"
                host_struct["network_interfaces"] = list()
                host_struct["local_applications"] = list()

                interface_struct = dict()
                interface_struct["ipaddress"] = "192.168.1.1"
                interface_struct["macaddress"] = "ff:ff:ff:ff:ff:ff"
                interface_struct["ports"] = list()

                current_vulnerability_set = set()
                current_port_number = 1
                while len(current_vulnerability_set) < num_vulns/2:
                    port_struct = dict()
                    port_struct["number"] = current_port_number
                    port_struct["state"] = "open"
                    port_struct["protocol"] = "TCP"

                    advisory = random.choice(sorted_advisory_keys)
                    chosen_cve = advisory_to_cve[advisory]

                    # Cut excess
                    elements_to_cut = int(len(chosen_cve)+len(current_vulnerability_set) - (num_vulns/2))
                    if elements_to_cut > 0:
                        chosen_cve = chosen_cve.copy()
                        for i in range(elements_to_cut):
                            chosen_cve.pop()

                    current_vulnerability_set = current_vulnerability_set.union(set(chosen_cve))

                    port_struct["service"] = {"name":"dummy_from_"+advisory,"cpe_list":list(),"cve_list":advisory_to_cve[advisory]}
                    # port_struct["cve_list"] = advisory_to_cve[advisory]

                    interface_struct["ports"].append(port_struct)
                    current_port_number = current_port_number + 1

                host_struct["network_interfaces"].append(interface_struct)

                current_local_number = 1
                while len(current_vulnerability_set) < num_vulns:
                    advisory = random.choice(sorted_advisory_keys)
                    chosen_cve = advisory_to_cve[advisory]

                    # Cut excess
                    elements_to_cut = len(chosen_cve)+len(current_vulnerability_set) - num_vulns
                    if elements_to_cut > 0:
                        chosen_cve = chosen_cve.copy()
                        for i in range(elements_to_cut):
                            chosen_cve.pop()

                    current_vulnerability_set = current_vulnerability_set.union(set(chosen_cve))

                    local_struct = dict()
                    local_struct["id"] = current_local_number
                    local_struct["name"] = "dummy_from_"+advisory
                    local_struct["service"] = list()

                    service_struct = dict()
                    service_struct["name"] = "dummy_from_"+advisory
                    service_struct["cpe_list"] = list()
                    service_struct["cve_list"] = advisory_to_cve[advisory]

                    local_struct["service"].append(service_struct)

                    host_struct["local_applications"].append(local_struct)
                    current_local_number = current_local_number + 1

                total_vulnerability_set = total_vulnerability_set.union(current_vulnerability_set)
                host_list.append(host_struct)



            # Generate edges
            logging.info("[GENERATION] Real scenario, edges with strategy:%d-step:%d", strategy,step)
            edge_list = list()
            edge_index_1 = 0
            for host1 in host_list:
                host1_id = host1["id"]

                edge_index_2 = 0
                for host2 in host_list:
                    host2_id = host2["id"]

                    edge_list.append({
                        "host_link": [edge_index_1,edge_index_2],
                        "id_link": [host1_id,host2_id]
                    })

                    edge_index_2 = edge_index_2 + 1
                edge_index_1 = edge_index_1 + 1



            # Fetch vulnerabilities
            logging.info("[GENERATION] Real Scenraio, vulnerabilities strategy:%d-step:%d", strategy,step)
            vulnerability_list = list()
            for page in nvd_resource:
                for nvd_cve_struct in page["vulnerabilities"]:
                    if nvd_cve_struct["cve"]["id"] in total_vulnerability_set:
                        vulnerability_list.append(nvd_cve_struct["cve"])


            if not os.path.exists(RealInventoryGenerator.INVENTORIES_ROOT_FOLDER): os.mkdir(RealInventoryGenerator.INVENTORIES_ROOT_FOLDER)

            # Compile environment
            f = open(RealInventoryGenerator.INVENTORIES_ROOT_FOLDER+"f"+str(strategy)+"_s"+str(step)+".json",mode="w",encoding="utf-8")
            environment_struct = dict()
            environment_struct["devices"] = host_list
            environment_struct["vulnerabilities"] = vulnerability_list
            environment_struct["edges"] = edge_list
            f.write(json.dumps(environment_struct))
            f.close()

            logging.info("[GENERATION] END GENERATION of strategy:%d-step:%d", strategy,step)
        
        except Exception as e:
            traceback.print_exc()
            logging.error("%s",e)